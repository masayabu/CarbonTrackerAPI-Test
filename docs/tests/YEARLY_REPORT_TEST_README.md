# GetYearlyReport API テストガイド

このドキュメントでは、GetYearlyReport APIの2023年データ取得テストの実行方法について説明します。

## 概要

`test_yearly_report_2023.js` は、GetYearlyReport APIが2023年のデータを正しく取得できるかをテストするスクリプトです。

## テスト内容

### 1. 2023年年次レポート取得テスト
- 2023年のデータが正しく取得できるか
- レスポンス形式が正しいか（12ヶ月分のデータ）
- 各月のデータ構造が正しいか
- データの合計値が正しく計算されているか

### 2. 無効な年パラメータテスト
- 無効な年パラメータ（文字列、小数、空文字など）が正しく拒否されるか
- 適切なエラーレスポンス（400 Bad Request）が返されるか

### 3. 存在しない年のテスト
- 存在しない年のリクエストが適切に処理されるか
- 空のデータ（すべて0）が返されるか

### 4. レスポンス形式検証
- 各月のデータに必須フィールドが含まれているか
- データ型が正しいか（数値型）
- 負の値が含まれていないか

### 5. 2023-09-24のデータ検証
- 2023年9月24日に登録されたデータが正しく取得できるか
- 9月のデータが年次レポートに正しく反映されているか
- 9月のデータの詳細検証（データ型、値の妥当性）

## 実行方法

### 前提条件
1. Azure Functionsが起動していること
2. データベースに2023年のデータが存在すること（テスト用データ）
3. 2023年9月24日のデータが登録されていること

### テスト実行

#### 方法1: npmスクリプトを使用
```bash
npm run test:yearly-report
```

#### 方法2: 直接実行
```bash
node run_yearly_report_test.js
```

#### 方法3: テストファイルを直接実行
```bash
node test_yearly_report_2023.js
```

## テスト結果の解釈

### 成功の場合
```
🎉 すべてのテストが成功しました！GetYearlyReport APIは正しく動作しています。
```

### 失敗の場合
```
⚠️ 一部のテストが失敗しました。APIの実装を確認してください。
```

## 期待されるレスポンス形式

```json
[
  {
    "month": 1,
    "totalBamboo": 100,
    "totalCharcoal": 25,
    "totalCO2Reduction": 73.5
  },
  {
    "month": 2,
    "totalBamboo": 150,
    "totalCharcoal": 37.5,
    "totalCO2Reduction": 110.25
  },
  // ... 12ヶ月分のデータ
]
```

## トラブルシューティング

### よくある問題

1. **接続エラー**
   - Azure Functionsが起動しているか確認
   - ポート7071が使用可能か確認

2. **データが見つからない**
   - データベースに2023年のデータが存在するか確認
   - 2023年9月24日のデータが登録されているか確認
   - テスト用データを作成する

3. **認証エラー**
   - GetYearlyReport APIは認証不要（authLevel: "anonymous"）
   - 他のAPIとの混同がないか確認

### デバッグ方法

1. ログを確認する
2. データベースの内容を確認する
3. APIの実装を確認する

## 関連ファイル

- `tests/api/test_yearly_report_2023.js` - メインテストファイル
- `tests/utils/run_yearly_report_test.js` - テスト実行スクリプト
- `src/functions/GetYearlyReport/index.ts` - API実装
- `package.json` - npmスクリプト設定

## 注意事項

- このテストは2023年のデータに特化しています
- 他の年のテストが必要な場合は、スクリプトを修正してください
- 本番環境でテストを実行する場合は、適切なURLに変更してください
